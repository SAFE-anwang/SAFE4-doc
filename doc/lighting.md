闪电网络
- 安网4拟引入闪电网络技术，闪电网络（Lighting Network）的思路是把大量小额交易放到区块链之外，仅在区块链上纪录初始和最终状态，因而可以显著减少在区块链上纪录的交易数量，通过RSMC（Recoverable Sequence Maturity Contract）和 HTLC（Hashed Timelock Contract）两个技术来实现。前者解决了链下交易的确认问题，后者解决了支付通道的问题。

- RSMC即可撤销的顺序成熟合约，其技术原理：首先交易双方建立“微支付通道”，交易双方预存一部分资金到“微支付通道”里，初始情况下双方的分配方案等于预存的金额，每次交易后双方签名确认资金分配方案，同时把旧版分配方案作废。任何一方提现时，将双方签名过的分配方案写到区块链中，从而被确认，资金按照分配到两方手里。上述过程中，只有在预存资金和资金提现时才需要区块链。

  提现一方提交的资金分配方案可能是某次交易后的结果，但未必是最新的结果。为安全起见，闪电网络规定提现一方的资金到账时间要晚于对方，对方可以马上到账，但提现一方却需要1000个区块之后才能到账，在这段时间内，如果对方证明此方案之前已经作废，则所有资金罚没给对方，确保提现一方必须诚实。

- HTLC微支付通道是通过“哈希和时钟锁定合约”来实现，AB双方约定：A先冻结一笔钱，并提供一个哈希值h，如果在一定时间内B能提交此哈希值的源像v，使得h=hash(v)，则这笔钱转给B。源像v就是暗语，知道这个暗语就可以获得这笔钱，而这个暗语没法通过破解来获得，只能A方给予。

  HTLC 机制可以扩展到多个人的场景。A想转账v给C，C发给A一个哈希值。A跟Ｂ签订一个合约，如果B在一定时间内告诉A与哈希值对应的暗语，A就给B金额为v的钱；B跟C签订一个合约，如果C告诉B那个暗语，B就给C金额v；C于是告诉B暗语，拿到B金额ｖ，B又从A拿到金额v。最终结果是A转账给Ｃ。这样A和C之间构成了一条支付通道，该条支付通道建立在两条微支付通道之上。

RSMC 确保两方之间的直接交易通过微支付通道在链下完成，HTLC 确保任意两方之间的交易都可以通过一条完整的支付通道来完成，该支付通道可以途径多条微支付通道。闪电网络整合这两种机制，实现任意两方之间的交易都可在链下完成。

- 在安网闪电网络上的交易，我们称之为闪电支付。安网的主节点是现成的闪电网络节点，安网４把闪电网络和安网区块链有机整合在一起，安网４的原生资产有可能在支付通道中，且可随时提现。

- 安网４融合闪电网络技术有如下好处：

  - 快速支付：闪电支付实时完成，无需区块链确认，且更安全，可用于大规模线下支付，使得安网SAFE可作为零售行业的支付平台和货币；如果在安网上引入稳定币，则安网完全可作为一种稳定的、大规模的支付手段。
  - 性能提升：闪电网络带离了几乎所有的安码ERC20的transfer操作、大部分的UTXO交易，使得主节点进行安网交易确认、运行安码EVM的压力骤降，区块链容量减少，存贮区块链空间需求减少，安网运行更快，无需提升主节点硬件配置，方便去中心化。
  - 隐私保护：闪电支付的众多中间交易状态并未记录在区块链上，仅记录初始状态和结束状态，因而有保护交易隐私的作用。
  - 无需费用：闪电支付的众多中间交易无需任何费用，仅纪录在区块链上的交易需要费用，与安码ERC20的费用相比，近乎免交易费。
  
- 有两个问题需要解决：

  - 如何建立多个微支付通道以形成支付网络，以方便闪电交易； 
  - 如何让锁定在微支付通道中的SAFE，有回报有收益；
