原子兑换  

&emsp;&emsp;原子兑换发生在SAFE和其他区块链的加密货币之间，如BTC、BCH、ETH和ERC20代币、LTC、BNB和BEP20代币、DASH等，这就意味着SAFE钱包需要以RPC或SPV支持其他区块链的钱包。  
    
&emsp;&emsp;假设有A、B两方，A有SAFE，需要BTC；B有BTC，要交换SAFE；他们可以把拥有的币种转到中心化交易所，然后直接兑换成BTC或SAFE，或者卖成USDT再购买所需币种；如果他们想直接在钱包中以去中心化的方式完成彼此兑换，可以遵照如下步骤进行：

1.  前期准备  
    - A确保SAFE钱包有充足金额的SAFE；
    - B准备好充足金额的BTC；
    - B把BTC转入SAFE钱包控制的BTC钱包或地址，以下两个方法都可以：  
      - 以SAFE钱包连接Bitcoin Core钱包的RPC接口，确保Bitcoin Core钱包中有正确金额的BTC；
      - 在SAFE钱包中按照BIP39/BIP32标准生成BTC地址，把BTC转入该地址；

2.  订单撮合  
    - A在SAFE钱包的原子兑换功能中发布一个买单，花费v个SAFE，以价格p购买BTC（或B发布一个卖单，以价格p卖出BTC，BTC数量w）, 该买(卖)单发布在SAFE网络上；
    - B在SAFE钱包的原子兑换功能中接受该买单（即发送一个全网交易），表明同意该买单的价格和金额；在接受操作之前SAFE钱包会检查所控制的BTC钱包金额是否充足；  
      如果有两个用户同时接受该买单，以全网交易的确认区块数为准，如果在同一个区块中，则以交易顺序为准；
    - A的买单被B锁定，AB双方开始兑换过程；

3. 兑换过程(针对BTC系币种)  
    - A选择一个随机数X，计算H=HASH160(X),用于创建SAFE交易1；
    - A创建SAFE交易1，TX1@SAFE:"支付v个SAFE给<B的公钥>，如果B签名并且知道X，或者A和B同时签名"；
    - A创建SAFE交易2，TX2@SAFE:"从TX1@SAFE中支付v个SAFE给<A的公钥>，需要锁定48小时和A签名"；
    - A发送TX2@SAFE给B，B签名后返回A；
    - A发布TX1@SAFE到SAFE网络，等待确认；
    - B检查TX1@SAFE并且获取H=HASH160(X)，用于创建BTC交易1；
    - B创建BTC交易1，TX1@BTC:"支付w个BTC给<A的公钥>,如果A签名并且知道X，或者A和B同时签名";
    - B创建BTC交易2，TX2@BTC:"从TX1@BTC中支付w个BTC给<B的公钥>,需要锁定24小时和B签名";
    - B发送TX2@BTC给A，A签名后返回B；
    - B发布TX1@BTC到BTC网络，等待确认；
    - A发布新交易花费TX1@BTC交易，从中获得w个BTC，但泄露X；
    - B利用X，发布新交易花费TX1@SAFE交易，从中获得v个SAFE；

4. 意外处理  
    - A和B随时可能作假和退出，在这两种情况要保证诚实一方的资产不会丢失；
    - A发布TX1@SAFE之前，双方随时可以停止交易，无需处理，不会损失任何资产；
    - A发布TX1@SAFE之后，B作假或反悔退出，则A可以在48小时后发布TX2@SAFE，即可拿回自己的SAFE币；
    - B发布TX1@BTC后，A未花费TX1@BTC也未揭露X，则B方可在24小时后发布TX2@BTC拿回BTC，A可以在48小时后发布TX2@SAFE拿SAFE；
    
5. 订单管理  
    - 订单包括购买（卖出）币种、购买（卖出）金额、价格、过期时间（默认1天）等；
    - 订单状态：开放=>锁定=>SAFE锁定中=>其他币锁定中=>A获得其他币确认中=>B获得SAFE确认中=>完成
        - SAFE锁定中详细状态：  A生成交易中=>B签名中=>SAFE锁定交易确认中 =>B校验SAFE交易中
        - 其他币锁定中详细状态：B生成交易中=>A签名中=>其他币锁定交易确认中=>A校验其他币交易中
    - 意外情况的订单状态:
        - 用户取消订单：开放=>A或B取消；需要发送取消订单交易；
        - 订单过期：开放=>过期；无需发送交易；
        - 订单锁定后30分钟内A未发布TX1@SAFE：开放=>锁定=>SAFE锁定中=>A取消；
        - A发布TX1@SAFE之后，B作假或反悔退出，B未在1个小时内发布TX1@BTC：开放=>锁定=>SAFE锁定中=>B取消；
        - B发布TX1@BTC后，A未花费TX1@BTC也未揭露X：开放=>锁定=>SAFE锁定中=>其他币锁定中=>A取消；
    - 拥有SAFE去购买其他币种的订单称为买单，反之拥有其他币种去购买SAFE的订单叫卖单，许多用户的买单和卖单共同形成一个订单本；
    - 针对买单的接受交易，称为买单锁定；同样的，针对卖单的接受交易称为卖单锁定；
    - 兑换过程由拥有SAFE的用户A发起，拥有其他币种的为响应方B；
    - 订单被锁定后，就从订单本删除，转移到正在执行的订单池中，后续的接受订单交易都不可受理；
    - 订单要么不成交，要么全部成交，不存在部分成交的情况；
    - 可同时发起多个订单锁定，只需资产足够，分别完成即可；

